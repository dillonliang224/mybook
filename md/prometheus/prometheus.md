# Prometheus æ™®ç½—ç±³ä¿®æ–¯

## Introduction



**ä»€ä¹ˆæ˜¯Prometheus?**



### Overview

Prometheusæ˜¯æœ€åˆåœ¨SoundCloudä¸Šæ„å»ºçš„å¼€æºç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿã€‚

è‡ª2012å¹´æˆç«‹ä»¥æ¥ï¼Œè®¸å¤šå…¬å¸å’Œç»„ç»‡é‡‡ç”¨äº†Prometheusï¼Œå¹¶ä¸”è¯¥é¡¹ç›®æ‹¥æœ‰æ´»è·ƒçš„å¼€å‘è€…å’Œç¤¾åŒºã€‚

ç°åœ¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œå¹¶ä¸”ç‹¬ç«‹äºä»»ä½•å…¬å¸è¿›è¡Œç»´æŠ¤ã€‚

ä¸ºäº†å¼ºè°ƒè¿™ä¸€ç‚¹å¹¶é˜è¿°é¡¹ç›®çš„æ²»ç†ç»“æ„ï¼ŒPrometheusåœ¨2016å¹´åŠ å…¥äº†Cloud Native Computing Foundation(CNCF äº‘åŸç”ŸåŸºé‡‘ä¼š)ï¼Œæ˜¯ç»§Kubernetesä¹‹åçš„ç¬¬äºŒä¸ªæ‰˜ç®¡é¡¹ç›® ã€‚



#### Features

Prometheusçš„ä¸»è¦åŠŸèƒ½æœ‰ï¼š

- ä¸€ä¸ªå¤šç»´æ•°æ®æ¨¡å‹ï¼Œå…¶ä¸­åŒ…å«é€šè¿‡metric nameå’Œé”®/å€¼å¯¹æ ‡è¯†çš„æ—¶é—´åºåˆ—æ•°æ®

- PromQL, ä¸€ç§çµæ´»çš„æŸ¥è¯¢è¯­è¨€ç”¨æ¥æ£€ç´¢ä¸åŒç»´åº¦çš„æ•°æ®

- ä¸ä¾èµ–åˆ†å¸ƒå¼å­˜å‚¨ï¼›å•ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æ˜¯è‡ªæ²»çš„

- æ—¶é—´åºåˆ—æ”¶é›†é€šè¿‡HTTPä¸Šçš„æ‹‰æ¨¡å‹è¿›è¡Œ

- é€šè¿‡ä¸­é—´ç½‘å…³æ”¯æŒæ¨é€æ—¶é—´åºåˆ—

- é€šè¿‡æœåŠ¡å‘ç°æˆ–é™æ€é…ç½®å‘ç°ç›®æ ‡

- å¤šç§å›¾å½¢å’Œä»ªè¡¨ç›˜æ”¯æŒæ¨¡å¼



#### Components

Prometheusç”Ÿæ€ç³»ç»Ÿç”±å¤šä¸ªç»„å»ºç»„æˆï¼Œå…¶ä¸­è®¸å¤šæ˜¯å¯é€‰çš„ï¼š

- Prometheusä¸»æœåŠ¡å™¨ï¼Œæ”¶é›†å¹¶å­˜å‚¨æ—¶é—´åºåˆ—æ•°æ®

- å®¢æˆ·ç«¯åº“ï¼Œæ”¯æŒå¤šç§è¯­è¨€å¿«é€Ÿå¼€å‘

- æ”¯æŒç”Ÿå‘½å‘¨æœŸçŸ­çš„jobä¸»åŠ¨æ¨é€çš„ç½‘å…³

- special-purposeÂ [exporters](https://prometheus.io/docs/instrumenting/exporters/)Â for services like HAProxy, StatsD, Graphite, etc.

- å‘Šè­¦å¤„ç†å™¨

- å„ç§æ”¯æŒå·¥å…·



å¤§å¤šæ•°Prometheusç»„ä»¶éƒ½æ˜¯ç”¨Goç¼–å†™çš„ï¼Œä»è€Œä½¿å…¶æ˜“äºæ„å»ºå’Œéƒ¨ç½²ä¸ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶ã€‚



#### Architecture

è¯¥å›¾è¯´æ˜äº†Prometheusçš„ä½“ç³»ç»“æ„åŠå…¶æŸäº›ç”Ÿæ€ç³»ç»Ÿç»„ä»¶:

![](https://prometheus.io/assets/architecture.png)



Prometheusç›´æ¥æˆ–é—´æ¥ï¼ˆæ¨é€ç½‘å…³ï¼‰æ”¶é›†metricsæ•°æ®ã€‚å®ƒåœ¨æœ¬åœ°å­˜å‚¨æ‰€æœ‰çš„æ—¶åºæ•°æ®å¹¶å¯¹è¿™äº›æ•°æ®è¿è¡Œè§„åˆ™ï¼Œä»¥æ±‡æ€»å’Œè®°å½•ç°æœ‰æ•°æ®ä¸­çš„æ–°æ—¶é—´åºåˆ—æˆ–ç”Ÿæˆå‘Šè­¦ã€‚Grafanaæˆ–å…¶ä»–APIæ¶ˆè´¹è€…å¯ä»¥å¯è§†åŒ–æ”¶é›†çš„metricsæ•°æ®ã€‚



Prometheusé€‚åˆé‚£äº›éœ€è¦é‡‡æ ·åˆ†æçš„ç³»ç»Ÿï¼Œç›‘æ§æŒ‡æ ‡ï¼Œå‘é€æŠ¥è­¦ã€‚

å¯¹äºé‚£äº›éœ€è¦è¯¦ç»†è®°å½•çš„ç›‘æ§ï¼Œæ¯”å¦‚è¯´è®¢å•ç³»ç»Ÿï¼Œå°±ä¸é€‚åˆï¼ŒPrometheusä¸ä¼šæ”¶é›†çš„é‚£ä¹ˆè¯¦ç»†ï¼Œè®¡ç®—èµ„æºä¹Ÿå¯èƒ½ä¸å¤Ÿã€‚



### First Steps

Prometheus: æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸–ç•Œï¼Œå¨‡è´µçš„å°å…¬ä¸»ã€‚

Prometheus: æˆ‘æ˜¯ä¸€ä¸ªé€šè¿‡HTTPè¯·æ±‚æ”¶é›†å„ä¸ªendpointsä¸Šmetricsçš„ç›‘æ§å¹³å°ã€‚

Prometheus: æ¥ä¸‹æ¥æˆ‘ä¼šå‘Šè¯‰ä½ å¦‚ä½•å®‰è£…ã€é…ç½®ï¼Œå¹¶ç›‘æ§ç¬¬ä¸€ä¸ªèµ„æºdemoã€‚

Prometheus: ä½ éœ€è¦ä¸‹è½½å¹¶å®‰è£…Prometheusï¼Œä¹Ÿè¦ä¸‹è½½exporter(ä¸€ä¸ªä»æœåŠ¡å™¨ä¸Šå¯¼å‡ºmetricsçš„å·¥å…·)ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªdemoå°†æ˜¯Prometheusæœ¬èº«ï¼Œå®ƒä¼šæä¾›ä¸€ç³»åˆ—çš„ç›‘æ§æŒ‡æ ‡ï¼Œæ¯”å¦‚è¯´ï¼šå†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒGCç­‰ç­‰ã€‚



#### Downloading Prometheus

æ ¹æ®ä½ çš„å¹³å°ï¼Œé€‰æ‹©æœ€æ–°releaseä¸‹è½½å¹¶è§£å‹ï¼š

```bash
tar xvfz prometheus-*.tar.gz
cd prometheus-*
```

è§£å‹å‡ºæ¥çš„Prometheus serveræ˜¯ä¸€ä¸ªå•ç‹¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š prometheus(æˆ–è€…prometheus.exe windowsç³»ç»Ÿ)ã€‚

æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰§è¡Œ--help flagæŸ¥çœ‹å¸®åŠ©ã€‚

```bash
./prometheus --help
```

åœ¨å¼€å§‹ä½¿ç”¨Prometheusä¹‹å‰ï¼Œè®©æˆ‘ä»¬é…ç½®ä¸€ä¸‹å®ƒå§ã€‚



#### Configuring Prometheus

[First steps | Prometheus](https://prometheus.io/docs/introduction/first_steps/)



## Concepts

### Data model

Prometheusä»æ ¹æœ¬ä¸ŠæŠŠæ‰€æœ‰æ•°æ®å­˜ä¸ºæ—¶åºæ•°æ®ï¼šå±äºåŒä¸€åº¦é‡æ ‡å‡†å’ŒåŒä¸€ç»„æ ‡æ³¨ç»´çš„å¸¦æœ‰æ—¶é—´æˆ³çš„å€¼æµã€‚é™¤äº†å­˜å‚¨çš„æ—¶é—´åºåˆ—å¤–ï¼ŒPrometheuså¯èƒ½ä¼šç”Ÿæˆä¸´æ—¶çš„å¯¼å‡ºæ—¶é—´åºåˆ—ä½œä¸ºæŸ¥è¯¢çš„ç»“æœã€‚



#### Metric names and labels

æ¯ä¸ªæ—¶é—´åºåˆ—å‡ç”±å…¶**metric name**å’Œå¯é€‰çš„**é”®å€¼å¯¹(label)**ä½œä¸ºå”¯ä¸€æ ‡è¯†

metric nameä¸€èˆ¬æŒ‡å®šè¦åº¦é‡çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚è¯´http_requests_total, ä»£è¡¨æ¥å—åˆ°çš„http requestsçš„æ€»å’Œï¼‰ã€‚å®ƒå¯èƒ½åŒ…å«ASCIIå­—æ¯å’Œæ•°å­—ï¼Œä»¥åŠä¸‹åˆ’çº¿å’Œå†’å·ã€‚å®ƒå¿…é¡»ä¸æ­£åˆ™è¡¨è¾¾å¼[a-zA-Z _ï¼š] [a-zA-Z0-9 _ï¼š] *ç›¸åŒ¹é…ã€‚



Note: å†’å·æ˜¯ä¸ºç”¨æˆ·å®šä¹‰çš„è®°å½•è§„åˆ™ä¿ç•™çš„ã€‚

> They should not be used by exporters or direct instrumentation.



å¯ä»¥é€šè¿‡labelsçš„è‡ªç”±ç»„åˆæ¥é‡‡é›†æ—¶åºæ•°æ®å¹¶å±•ç¤ºã€‚

labelsåå­—å¯èƒ½åŒ…å«ASCIIå­—æ¯ã€æ•°å­—ä»¥åŠä¸‹åˆ’çº¿ã€‚ä¸‹åˆ’çº¿å¼€å¤´çš„labelsè¢«ä¿ç•™ä¸ºå†…éƒ¨ä½¿ç”¨ã€‚

labelå€¼å¯ä»¥åŒ…å«ä»»ä½•Unicodeå­—ç¬¦ã€‚

å¦‚æœä¸€ä¸ªlabelåªæœ‰keyï¼Œæ²¡æœ‰valueï¼Œé‚£ä¹ˆè¿™ä¸ªlabelç›¸å½“äºä¸å­˜åœ¨ã€‚



ä¸¾ä¸ªğŸŒ°ï¼š

```shell
api_http_requests_total{method="POST", handler="/messages"}
```

å…¶ä¸­api_http_requests_totalä¸ºè¦åº¦é‡çš„metric name

method="POST"å’Œhandler="/message"æ˜¯å¯é€‰çš„labels



### Metric types

Prometheuså®¢æˆ·ç«¯åº“æä¾›äº†4ä¸ªæ ¸å¿ƒmetricç±»å‹

#### Counter

è®°å½•appé‡Œç´¯è®¡çš„æ•°å€¼ï¼Œæ­¤å€¼åªèƒ½è¢«å¢åŠ æˆ–è€…é‡å¯çš„æ—¶å€™è¢«é‡ç½®ã€‚

#### Gauge

è®°å½•å•ä¸ªæŒ‡æ ‡çš„ä»»æ„çš„ä¸Šå‡æˆ–ä¸‹é™ï¼Œæ¯”å¦‚è¯´æ¸©åº¦è®¡æˆ–å½“å‰å†…å­˜çš„ä½¿ç”¨é‡ï¼Œå½“å‰ç³»ç»Ÿæ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°

#### Histogram

ç›´æ–¹å›¾ï¼Œæ¯”å¦‚è¯´ç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚æ—¶é—´ï¼Œå“åº”å¤§å°ï¼Œé‡‡æ ·ç»Ÿè®¡ã€‚

#### Summary

å’Œhistogramç±»ä¼¼ï¼Œä½†å¯ä»¥ç»Ÿè®¡è¢«è§‚æµ‹è€…æ•°æ®çš„totalå’Œsum.

### Jobs and instances

åœ¨prometheusé‡Œï¼Œå¾…æŠ“å–çš„endpointè¢«ç§°ä¸º*instance*ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚

å¤šä¸ªå…·æœ‰ç›¸åŒç›®çš„çš„instance(æ¯”å¦‚é›†ç¾¤ä¸­ç›¸åŒä»£ç çš„å®ä¾‹)çš„é›†åˆï¼Œè¢«ç§°ä¸º*job*ã€‚



For example, ä¸€ä¸ªæä¾›APIçš„æœåŠ¡jobæ‹¥æœ‰4ä¸ªç›¸åŒçš„instance:

- job: api-server
  
  - instance1: 1.2.3.4:5670
  
  - instance2: 1.2.3.4:5671
  
  - instance3: 5.6.7.8:5670
  
  - instance4: 5.6.7.8:5671



#### Automatically generated labels and time series

å½“PrometheusæŠ“å–ç›®æ ‡æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åœ¨æŠ“å–çš„æ—¶é—´åºåˆ—ä¸Šé™„åŠ ä¸€äº›æ ‡ç­¾ï¼Œä»¥è¯†åˆ«è¢«æŠ“å–çš„ç›®æ ‡ï¼š

- job: è¢«æŠ“å–ç›®æ ‡æ‰€å±jobåç§°ã€‚

- instance: è¢«æŠ“å–ç›®æ ‡URLä¸­çš„<host>:<port>



å¯¹äºæ¯ä¸ªè¢«æŠ“å–çš„instanceï¼Œprometheusä¼šå­˜å‚¨ä¸€äº›é‡è¦çš„æŒ‡æ ‡ï¼š

- up{job="job-name", instance="instance-id"}: å¦‚æœinstanceå¥åº·çš„ï¼Œè®¾ç½®ä¸º1ï¼Œå¦åˆ™è®¾ç½®ä¸º0





## Prometheus


