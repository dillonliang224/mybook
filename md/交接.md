## Node

### 金币项目

- [源码&&READMD.md](https://gitlab.ushaqi.com/zhuishu-micro-svc/goldcoin-svc.git)

- [线上配置]([Sign in · GitLab](https://gitlab.ushaqi.com/zhuishu-config/goldcoin.git))

- [线上部署]([Sign in · GitLab](https://gitlab.ushaqi.com/zhuishu-micro-svc/micro-svc-ansible.git))

- [管理后台]([追书神器管理后台](http://admin-v2.zhuishushenqi.com/#/goldcoin/account-detail?_k=jydtub))

- [自建监控系统](http://monitoring.zs:3000/)

- [运维监控系统]([Grafana](http://zabbix.zhuishushenqi.com:3000/d/000000040/jin-bi-jian-kong?))

主要业务：

- 任务中心

- 师徒

- 提现
1. 提现涉及到BI数据分析，定时脚本每日同步提现分析数据到金币（sync-bi-audit-account.js）

2. 天天夺宝定时任务（treature-open.js && treature-mock-peopeo.js）

3. 金币项目里存在两套消息队列（和主项目通信，金币本身的镜像队列）

   4. 师徒邀新：首邀奖励

   5. 提现需分享好友并绑定

6. 阅读时间和签到之间看代码，配置在mongodb里

服务器相关：

```
D6ORE6dhY7VjA1QvPZRD7（更新）
ssh端口：65522
```

micro-svc-ansible:

初始化： root   JTSSY7tvRSs6eq2t2MBES

解密： d41d8cd98f00b204e9800998ecf8427e

#### 测试环境部署

1. 前置条件参考： [Sign in · GitLab](https://gitlab.ushaqi.com/zhuishu/dept-docs/blob/master/%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E.md)

2. 到自己到目录下操作如下
   
   ```bash
   cd /home/lf/workplace
   git clone git@gitlab.ushaqi.com:zhuishu-micro-svc/goldcoin-svc.git
   cd goldcoin
   nvm use v8
   npm install
   npm run build
   ```

3. 启动API&&Admin API(使用pm2并指定端口后，参照1配置域名)

4. 启动worker(当前目录下有worker-gold.sh脚本，一键启动)

5. 每次更新代码都需要npm run build

### 主项目业务

购买章节涉及到的worker: purchase-chapter.js (k8s)

神策新用户注册推数据： sync-data-to-sensors.js (backendc7.zs)

异业合作worker: after-user-register.js (backendc7.zs)

所有主项目worker，不在k8s里的，需要检查backendc1/c7

Node: 修改书籍缓存的时候（新增字段），要修改purchase项目和主项目（其他项目如果有引用相同的key，也需要修改）

## Golang

### 异业合作

项目地址： [Sign in · GitLab](https://gitlab.ushaqi.com/zhuishu-micro-svc/reborn)

src/web/business

src/admin/business

### 书籍卡点

大仓admin-book更新书籍 -> go-booksvc提供GRPC -> purchase使用

### 消耗业务相关参考

文档地址： [Sign in · GitLab](https://gitlab.ushaqi.com/zhuishu-micro-svc/ran-doc)

### 充值消耗数据同步业务

项目地址： [Sign in · GitLab](https://gitlab.ushaqi.com/zhuishu/sync-tool.git)

**核心逻辑：拉取追书的充值，消耗数据，通过业务逻辑整理成bi需要的数据，写入mysql，让bi抓取**

**涉及到的db配置信息都在 /data/syncData/run.sh 里能看到**

##### 项目说明：

- **服务器**

- 业务服务器：10.10.146.253

- mysql: mysql://etl_write:nW8WIR9tOIsC4hFQ@10.10.146.253/bi_data_etl?timezone=+0800

- **涉及到的追书原始DB**

- 28个mysql只读从库，地址在redis10.10.163.178中存储：**hgetall udb_gleeman_slave_ip**）

- 10.19.133.3 mongodb，gleeman-expand ，消耗扩展字段库，记录消耗的客户端版本等扩展字段

- 10.10.139.3 mongodb，gleeman_adOrder， 看广告免费读消耗记录

- **BI文档**：

- [消费订单结构定义](https://git.zhuishushenqi.com/interface/bi-open-docs/tree/master/%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/%E6%B6%88%E8%B4%B9%E8%AE%A2%E5%8D%95%E6%8E%A5%E6%94%B6)

- [充值订单结构定义](https://git.zhuishushenqi.com/interface/bi-open-docs/tree/master/%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/%E5%85%85%E5%80%BC%E8%AE%A2%E5%8D%95%E6%8E%A5%E6%94%B6)

- **编译**

- make build

- **执行**

- ./run.sh

- **部署路径**

- /data/syncData

- **核心文件**

- **wh_sync_order.go** 同步书币书券消耗数据

- **wh_sync_charge_order.go** 同步充值数据

- **wh_sync_adOrder.go** 同步广告消耗数据

- **run.sh** 执行脚本，所有配置都在这里

- **执行过程**
1. crontab中添加了定时执行的计划

2. 定时执行脚本，脚本会将数据写到/data/syncData/biData/ 按时间类型命名的txt文件中，同时在mysql中增加一条记录

3. DBA定期从mysql读取新增文件记录，进行数据写入

### 其他项目

go-usersvc: user底层服务，提供RPC

go-booksvc: book底层服务，提供RPC

gateway: 鉴权包，用于鉴权服务

bookshelfsvc: 书架底层服务，提供RPC

bookshelf-agg: 书架聚合服务，提供http，从HA层全部切到golang

pentaprism: 鉴权服务，读取config.json配置

    - api ： GPRC鉴权服务

    - pentaprism: auth服务

    - tokenGen: 测试服专用

proto: protobuf文件维护，修改文件后会自动编译

genproto: proto生成的文件，自动生成pb文件，被底层服务引用

### 监控

http://monitoring.zs:3000/

### 测试环境部署

1. 本地查看makefile,执行make build-linux

2. 通过scp命令拷贝到测试服环境

3. 测试环境新建run.sh脚本，方便注入参数，使用run.sh启动

4. 实际操作时可参考测试环境/home/lf/goworkspace或者/home/huran/workspace
